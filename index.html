<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ABB IO List Generator v3.0 - Complete Solution</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --abb-red: #FF000F;
            --abb-gray: #E8E8E8;
            --abb-light-gray: #F0F0F0;
            --abb-dark: #333333;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f5f5 0%, #e0e0e0 100%);
            padding: 20px;
        }
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: var(--abb-red);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 { font-size: 32px; margin-bottom: 10px; }
        .header p { font-size: 14px; opacity: 0.9; }
        .tabs {
            display: flex;
            background: var(--abb-gray);
            border-bottom: 3px solid var(--abb-red);
            overflow-x: auto;
        }
        .tab {
            flex: 1;
            min-width: 140px;
            padding: 15px 10px;
            text-align: center;
            cursor: pointer;
            background: var(--abb-gray);
            border: none;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s;
        }
        .tab:hover { background: var(--abb-light-gray); }
        .tab.active { background: white; color: var(--abb-red); }
        .tab.disabled { opacity: 0.5; cursor: not-allowed; pointer-events: none; }
        .tab-content { display: none; padding: 30px; max-height: 70vh; overflow-y: auto; }
        .tab-content.active { display: block; }
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        .btn-primary { background: var(--abb-red); color: white; }
        .btn-primary:hover { background: #cc000c; transform: translateY(-2px); }
        .btn-secondary { background: var(--abb-gray); color: var(--abb-dark); }
        .btn-success { background: #28a745; color: white; font-size: 18px; padding: 20px 50px; }
        .upload-box {
            border: 3px dashed var(--abb-gray);
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            background: var(--abb-light-gray);
            cursor: pointer;
        }
        .upload-box:hover { border-color: var(--abb-red); background: white; }
        .upload-box.uploaded { border-color: #28a745; background: #d4edda; }
        .upload-icon { font-size: 64px; margin-bottom: 20px; }
        .file-input { display: none; }
        .alert {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .alert-info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .alert-danger { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 12px;
        }
        table th, table td {
            padding: 8px;
            text-align: left;
            border: 1px solid var(--abb-gray);
        }
        table th {
            background: var(--abb-red);
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        table tr:nth-child(even) { background: var(--abb-light-gray); }
        table tr:hover { background: #fff3f3; }
        .summary-box {
            background: var(--abb-light-gray);
            padding: 20px;
            border-radius: 5px;
            margin-top: 20px;
            border-left: 5px solid var(--abb-red);
        }
        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #ddd;
        }
        .summary-item label { font-weight: 600; }
        .summary-item span { color: var(--abb-red); font-weight: 700; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--abb-gray);
            border-radius: 5px;
            font-size: 14px;
        }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
        }
        .loading { text-align: center; padding: 40px; font-size: 18px; color: var(--abb-red); }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>âš¡ ABB IO List Generator</h1>
            <p>Complete Solution: Upload Customer IO List + Bulk Import Feeders + Manual Entry + Generate Excel with SUMMARY | v3.0</p>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="showTab('uploadIOList')">ðŸ“¤ IO List</button>
            <button class="tab disabled" id="tabUploadFeeders" onclick="showTab('uploadFeeders')">ðŸ“¥ Import Feeders</button>
            <button class="tab disabled" id="tabProject" onclick="showTab('project')">ðŸ“‹ Project</button>
            <button class="tab disabled" id="tabManual" onclick="showTab('manual')">âœï¸ Manual</button>
            <button class="tab disabled" id="tabReview" onclick="showTab('review')">ðŸ” Review</button>
            <button class="tab disabled" id="tabSummary" onclick="showTab('summary')">ðŸ­ Summary</button>
            <button class="tab disabled" id="tabGenerate" onclick="showTab('generate')">âš™ï¸ Generate</button>
        </div>
        
        <!-- Tab 1: Upload Customer IO List -->
        <div id="uploadIOList" class="tab-content active">
            <h2>ðŸ“¤ Step 1: Upload Customer IO List Template</h2>
            <div class="alert alert-warning">
                <strong>âš ï¸ REQUIRED:</strong> Upload your customer\'s IO List template to extract TYPICALS database.
            </div>
            <div class="upload-box" id="ioListBox" onclick="document.getElementById('ioListFile').click()">
                <div class="upload-icon">ðŸ“</div>
                <h3>Click to Upload Customer IO List</h3>
                <p style="margin-top: 10px;">Excel file (.xlsx, .xls) with TYPICALS worksheet</p>
                <input type="file" id="ioListFile" class="file-input" accept=".xlsx,.xls" onchange="handleIOListUpload(event)">
            </div>
            <div id="ioListStatus"></div>
            <div id="ioListInfo" style="display:none;">
                <div class="summary-box">
                    <h3>âœ… Customer IO List Uploaded</h3>
                    <div class="summary-item"><label>File:</label><span id="ioFileName"></span></div>
                    <div class="summary-item"><label>Equipment Types:</label><span id="ioEquipCount"></span></div>
                    <div class="summary-item"><label>Total Signals:</label><span id="ioSignalCount"></span></div>
                </div>
                <button class="btn btn-success" onclick="proceedToFeeders()">âž¡ï¸ Proceed to Import Feeders</button>
            </div>
        </div>
        
        <!-- Tab 2: Upload Feeders List -->
        <div id="uploadFeeders" class="tab-content">
            <h2>ðŸ“¥ Step 2: Import Feeders List (Bulk Import)</h2>
            <div class="alert alert-info">
                <strong>â„¹ï¸ FAST METHOD:</strong> Upload Excel/CSV with all feeders. Much faster than manual entry!
            </div>
            <div class="upload-box" id="feedersBox" onclick="document.getElementById('feedersFile').click()">
                <div class="upload-icon">ðŸ“Š</div>
                <h3>Click to Upload Feeders List</h3>
                <p style="margin-top: 10px;">Excel/CSV with columns: Substation, Voltage, Feeder ID, Name, Equipment Type, QTY</p>
                <input type="file" id="feedersFile" class="file-input" accept=".xlsx,.xls,.csv" onchange="handleFeedersUpload(event)">
            </div>
            <div id="feedersStatus"></div>
            <div style="margin-top: 20px;">
                <button class="btn btn-secondary" onclick="downloadFeedersTemplate()">ðŸ“¥ Download Template</button>
                <button class="btn btn-secondary" onclick="skipToManual()">â­ï¸ Skip (Use Manual Entry)</button>
            </div>
        </div>
        
        <!-- Tab 3: Project Setup -->
        <div id="project" class="tab-content">
            <h2>ðŸ“‹ Project Information</h2>
            <div class="grid-2">
                <div class="form-group">
                    <label>Project Name *</label>
                    <input type="text" id="projectName" placeholder="e.g., Vopak VEPA Prometheus">
                </div>
                <div class="form-group">
                    <label>Revision</label>
                    <input type="text" id="revision" placeholder="R0" value="R0">
                </div>
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea id="description" rows="3"></textarea>
            </div>
            <button class="btn btn-primary" onclick="saveProject()">ðŸ’¾ Save</button>
            <button class="btn btn-secondary" onclick="loadProject()">ðŸ“‚ Load</button>
        </div>
        
        <!-- Tab 4: Manual Entry -->
        <div id="manual" class="tab-content">
            <h2>âœï¸ Manual Feeder Entry (For Small Projects)</h2>
            <div class="form-group">
                <label>Select Substation</label>
                <select id="currentSub" onchange="loadFeeders()">
                    <option value="">-- Select --</option>
                </select>
                <button class="btn btn-primary" onclick="createSubstation()">âž• New Substation</button>
            </div>
            <div id="manualEntry" style="display:none;">
                <button class="btn btn-primary" onclick="addFeeder()">âž• Add Feeder</button>
                <table class="feeder-table">
                    <thead>
                        <tr>
                            <th>Voltage</th>
                            <th>Feeder ID</th>
                            <th>Name</th>
                            <th>Equipment Type</th>
                            <th>QTY</th>
                            <th>Signals</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="feedersBody"></tbody>
                </table>
            </div>
        </div>
        
        <!-- Tab 5: Review Feeders -->
        <div id="review" class="tab-content">
            <h2>ðŸ” Review All Feeders</h2>
            <div id="reviewContent"></div>
        </div>
        
        <!-- Tab 6: Summary -->
        <div id="summary" class="tab-content">
            <h2>ðŸ­ Substations Summary</h2>
            <div id="summaryContent"></div>
        </div>
        
        <!-- Tab 7: Generate -->
        <div id="generate" class="tab-content">
            <h2>âš™ï¸ Generate Final IO List</h2>
            <div class="alert alert-success">
                <strong>âœ… Ready to generate Excel file with:</strong>
                <ul style="margin-top: 10px; margin-left: 20px;">
                    <li>TYPICALS worksheet (from uploaded Customer IO List)</li>
                    <li>Individual substation worksheets</li>
                    <li>SUMMARY worksheet (all substations totals) â­</li>
                </ul>
            </div>
            <div class="summary-box" id="genSummary"></div>
            <div style="text-align: center; margin-top: 30px;">
                <button class="btn btn-success" onclick="generateExcel()">âš™ï¸ GENERATE EXCEL FILE</button>
            </div>
            <div id="genStatus"></div>
        </div>
    </div>
    
    <script>
        let projectData = {
            ioList: null,
            typicals: {},
            projectName: "",
            revision: "R0",
            description: "",
            substations: []
        };
        let ioListUploaded = false;
        
        function showTab(name) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(name).classList.add('active');
            event.target.classList.add('active');
            if (name === 'review') updateReview();
            if (name === 'summary') updateSummary();
            if (name === 'generate') updateGenSummary();
        }
        
        function handleIOListUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            document.getElementById('ioListStatus').innerHTML = '<div class="loading">â³ Parsing...</div>';
            const reader = new FileReader();
            reader.onload = function(ev) {
                try {
                    const data = new Uint8Array(ev.target.result);
                    const wb = XLSX.read(data, {type: 'array'});
                    if (!wb.SheetNames.includes('TYPICALS')) throw new Error('TYPICALS sheet not found!');
                    const sheet = wb.Sheets['TYPICALS'];
                    const rows = XLSX.utils.sheet_to_json(sheet, {header: 1});
                    projectData.typicals = parseTypicals(rows);
                    projectData.ioList = {fileName: file.name, date: new Date().toISOString().split('T')[0]};
                    ioListUploaded = true;
                    document.getElementById('ioListBox').classList.add('uploaded');
                    document.getElementById('ioListBox').innerHTML = '<div class="upload-icon">âœ…</div><h3>Uploaded!</h3>';
                    document.getElementById('ioFileName').textContent = file.name;
                    document.getElementById('ioEquipCount').textContent = Object.keys(projectData.typicals).length;
                    document.getElementById('ioSignalCount').textContent = Object.values(projectData.typicals).reduce((s,t) => s + t.signal_count, 0);
                    document.getElementById('ioListInfo').style.display = 'block';
                    document.getElementById('ioListStatus').innerHTML = '';
                    saveProject();
                } catch (err) {
                    document.getElementById('ioListStatus').innerHTML = '<div class="alert alert-danger">âŒ Error: ' + err.message + '</div>';
                }
            };
            reader.readAsArrayBuffer(file);
        }
        
        function parseTypicals(rows) {
            const typicals = {};
            let headerRow = -1;
            for (let i = 0; i < rows.length; i++) {
                if (rows[i][0] && rows[i][0].toString().includes('Types of Typicals')) {
                    headerRow = i;
                    break;
                }
            }
            if (headerRow === -1) throw new Error('Header not found');
            for (let i = headerRow + 2; i < rows.length; i++) {
                const row = rows[i];
                if (!row || !row[0]) continue;
                const eqType = row[0];
                if (!typicals[eqType]) {
                    typicals[eqType] = {
                        description: eqType,
                        signal_count: 0,
                        mms_di: 0, mms_do: 0, mms_ai: 0, mms_ao: 0,
                        goose_di: 0, goose_do: 0, goose_ai: 0, goose_ao: 0,
                        ied_count: 0, modbus_count: 0
                    };
                }
                typicals[eqType].signal_count++;
                if (row[12]) typicals[eqType].mms_di += parseInt(row[12]) || 0;
                if (row[13]) typicals[eqType].mms_do += parseInt(row[13]) || 0;
                if (row[14]) typicals[eqType].mms_ai += parseInt(row[14]) || 0;
                if (row[15]) typicals[eqType].mms_ao += parseInt(row[15]) || 0;
                if (row[16]) typicals[eqType].goose_di += parseInt(row[16]) || 0;
                if (row[17]) typicals[eqType].goose_do += parseInt(row[17]) || 0;
                if (row[18]) typicals[eqType].goose_ai += parseInt(row[18]) || 0;
                if (row[19]) typicals[eqType].goose_ao += parseInt(row[19]) || 0;
                if (row[20]) typicals[eqType].ied_count = Math.max(typicals[eqType].ied_count, parseInt(row[20]) || 0);
                if (row[21]) typicals[eqType].modbus_count = Math.max(typicals[eqType].modbus_count, parseInt(row[21]) || 0);
            }
            return typicals;
        }
        
        function proceedToFeeders() {
            enableTab('tabUploadFeeders');
            enableTab('tabProject');
            enableTab('tabManual');
            enableTab('tabReview');
            enableTab('tabSummary');
            enableTab('tabGenerate');
            showTab('uploadFeeders');
        }
        
        function enableTab(id) {
            document.getElementById(id).classList.remove('disabled');
        }
        
        function handleFeedersUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            document.getElementById('feedersStatus').innerHTML = '<div class="loading">â³ Importing feeders...</div>';
            const reader = new FileReader();
            reader.onload = function(ev) {
                try {
                    const data = new Uint8Array(ev.target.result);
                    const wb = XLSX.read(data, {type: 'array'});
                    const sheet = wb.Sheets[wb.SheetNames[0]];
                    const rows = XLSX.utils.sheet_to_json(sheet);
                    importFeeders(rows);
                    document.getElementById('feedersBox').classList.add('uploaded');
                    document.getElementById('feedersBox').innerHTML = '<div class="upload-icon">âœ…</div><h3>Imported ' + rows.length + ' feeders!</h3>';
                    document.getElementById('feedersStatus').innerHTML = '<div class="alert alert-success">âœ… ' + rows.length + ' feeders imported successfully!</div>';
                    updateSubstationDropdown();
                    saveProject();
                } catch (err) {
                    document.getElementById('feedersStatus').innerHTML = '<div class="alert alert-danger">âŒ Error: ' + err.message + '</div>';
                }
            };
            reader.readAsArrayBuffer(file);
        }
        
        function importFeeders(rows) {
            rows.forEach(row => {
                const subName = row.Substation || row.substation || '';
                if (!subName) return;
                let sub = projectData.substations.find(s => s.name === subName);
                if (!sub) {
                    sub = {name: subName, feeders: []};
                    projectData.substations.push(sub);
                }
                const eqType = row['Equipment Type'] || row.equipment_type || '';
                const typ = projectData.typicals[eqType];
                sub.feeders.push({
                    voltage: row.Voltage || row.voltage || '6.3kV',
                    feederId: row['Feeder ID'] || row.feeder_id || '',
                    feederName: row['Feeder Name'] || row.feeder_name || row.Name || row.name || '',
                    equipmentType: eqType,
                    qty: parseInt(row.QTY || row.qty || 1),
                    signals: typ ? typ.signal_count * parseInt(row.QTY || row.qty || 1) : 0
                });
            });
        }
        
        function downloadFeedersTemplate() {
            const template = [
                ['Substation', 'Voltage', 'Feeder ID', 'Feeder Name', 'Equipment Type', 'QTY'],
                ['SS-061', '6.3kV', 'OUT-01', 'BOG Compressor 1', '3.3kV Main switchgear Outgoing (1801-MS-00001) - Feeder for MV VFD', '1'],
                ['SS-061', '400V', 'MTR-01', 'Air Compressor 1', '400 V  Soft Starter Motor feeders', '1']
            ];
            const ws = XLSX.utils.aoa_to_sheet(template);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Feeders');
            XLSX.writeFile(wb, 'Feeders_List_Template.xlsx');
        }
        
        function skipToManual() {
            showTab('project');
        }
        
        function createSubstation() {
            const name = prompt('Enter substation name (e.g., SS-061):');
            if (name && name.trim()) {
                if (projectData.substations.find(s => s.name === name)) {
                    alert('âŒ Already exists!');
                    return;
                }
                projectData.substations.push({name: name.trim(), feeders: []});
                updateSubstationDropdown();
                document.getElementById('currentSub').value = name.trim();
                loadFeeders();
                saveProject();
            }
        }
        
        function updateSubstationDropdown() {
            const sel = document.getElementById('currentSub');
            sel.innerHTML = '<option value="">-- Select --</option>';
            projectData.substations.forEach(s => {
                sel.innerHTML += '<option value="' + s.name + '">' + s.name + '</option>';
            });
        }
        
        function loadFeeders() {
            const subName = document.getElementById('currentSub').value;
            if (subName) {
                document.getElementById('manualEntry').style.display = 'block';
                renderFeeders();
            } else {
                document.getElementById('manualEntry').style.display = 'none';
            }
        }
        
        function addFeeder() {
            const subName = document.getElementById('currentSub').value;
            const sub = projectData.substations.find(s => s.name === subName);
            if (sub) {
                sub.feeders.push({voltage: '6.3kV', feederId: '', feederName: '', equipmentType: '', qty: 1, signals: 0});
                renderFeeders();
                saveProject();
            }
        }
        
        function renderFeeders() {
            const subName = document.getElementById('currentSub').value;
            const sub = projectData.substations.find(s => s.name === subName);
            if (!sub) return;
            let html = '';
            sub.feeders.forEach((f, i) => {
                html += '<tr>';
                html += '<td><select onchange="updateFeeder(' + i + ', \'voltage\', this.value)">';
                html += '<option value="36kV"' + (f.voltage === '36kV' ? ' selected' : '') + '>36kV</option>';
                html += '<option value="6.3kV"' + (f.voltage === '6.3kV' ? ' selected' : '') + '>6.3kV</option>';
                html += '<option value="400V"' + (f.voltage === '400V' ? ' selected' : '') + '>400V</option>';
                html += '</select></td>';
                html += '<td><input type="text" value="' + f.feederId + '" onchange="updateFeeder(' + i + ', \'feederId\', this.value)"></td>';
                html += '<td><input type="text" value="' + f.feederName + '" onchange="updateFeeder(' + i + ', \'feederName\', this.value)"></td>';
                html += '<td><select onchange="updateFeeder(' + i + ', \'equipmentType\', this.value)">';
                html += '<option value="">-- Select --</option>';
                for (const [key, val] of Object.entries(projectData.typicals)) {
                    html += '<option value="' + key + '"' + (f.equipmentType === key ? ' selected' : '') + '>' + val.description.substring(0, 40) + '</option>';
                }
                html += '</select></td>';
                html += '<td><input type="number" value="' + f.qty + '" min="1" onchange="updateFeeder(' + i + ', \'qty\', this.value)"></td>';
                html += '<td><input type="number" value="' + f.signals + '" readonly style="background:#f0f0f0;font-weight:bold;"></td>';
                html += '<td><button class="delete-btn" onclick="deleteFeeder(' + i + ')">ðŸ—‘ï¸</button></td>';
                html += '</tr>';
            });
            document.getElementById('feedersBody').innerHTML = html || '<tr><td colspan="7" style="text-align:center;">No feeders. Click Add Feeder.</td></tr>';
        }
        
        function updateFeeder(idx, field, val) {
            const subName = document.getElementById('currentSub').value;
            const sub = projectData.substations.find(s => s.name === subName);
            if (sub && sub.feeders[idx]) {
                sub.feeders[idx][field] = val;
                if (field === 'equipmentType' || field === 'qty') {
                    const f = sub.feeders[idx];
                    if (f.equipmentType && projectData.typicals[f.equipmentType]) {
                        f.signals = projectData.typicals[f.equipmentType].signal_count * parseInt(f.qty || 1);
                    }
                }
                renderFeeders();
                saveProject();
            }
        }
        
        function deleteFeeder(idx) {
            if (confirm('Delete this feeder?')) {
                const subName = document.getElementById('currentSub').value;
                const sub = projectData.substations.find(s => s.name === subName);
                if (sub) {
                    sub.feeders.splice(idx, 1);
                    renderFeeders();
                    saveProject();
                }
            }
        }
        
        function updateReview() {
            let html = '';
            projectData.substations.forEach(sub => {
                html += '<h3>' + sub.name + ' (' + sub.feeders.length + ' feeders)</h3>';
                html += '<table><thead><tr><th>Voltage</th><th>ID</th><th>Name</th><th>Equipment</th><th>QTY</th><th>Signals</th></tr></thead><tbody>';
                sub.feeders.forEach(f => {
                    html += '<tr><td>' + f.voltage + '</td><td>' + f.feederId + '</td><td>' + f.feederName + '</td><td>' + (projectData.typicals[f.equipmentType]?.description || '').substring(0, 40) + '</td><td>' + f.qty + '</td><td>' + f.signals + '</td></tr>';
                });
                html += '</tbody></table>';
            });
            document.getElementById('reviewContent').innerHTML = html || '<p>No feeders added yet.</p>';
        }
        
        function updateSummary() {
            let html = '';
            let totals = {feeders: 0, signals: 0, io: 0};
            projectData.substations.forEach(sub => {
                const feeders = sub.feeders.length;
                const signals = sub.feeders.reduce((s, f) => s + (parseInt(f.signals) || 0), 0);
                const io = calculateIO(sub);
                totals.feeders += feeders;
                totals.signals += signals;
                totals.io += io;
                html += '<div class="substation-card"><h4>' + sub.name + '</h4>';
                html += '<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:15px;">';
                html += '<div><strong>Feeders:</strong> ' + feeders + '</div>';
                html += '<div><strong>Signals:</strong> ' + signals + '</div>';
                html += '<div><strong>I/O:</strong> ' + io + '</div>';
                html += '</div></div>';
            });
            html += '<div class="summary-box"><h3>GRAND TOTAL</h3>';
            html += '<div class="summary-item"><label>Total Substations:</label><span>' + projectData.substations.length + '</span></div>';
            html += '<div class="summary-item"><label>Total Feeders:</label><span>' + totals.feeders + '</span></div>';
            html += '<div class="summary-item"><label>Total Signals:</label><span>' + totals.signals + '</span></div>';
            html += '<div class="summary-item"><label>Total I/O Points:</label><span>' + totals.io + '</span></div>';
            html += '</div>';
            document.getElementById('summaryContent').innerHTML = html;
        }
        
        function calculateIO(sub) {
            let total = 0;
            sub.feeders.forEach(f => {
                if (f.equipmentType && projectData.typicals[f.equipmentType]) {
                    const t = projectData.typicals[f.equipmentType];
                    const q = parseInt(f.qty) || 1;
                    total += (t.mms_di + t.mms_do + t.mms_ai + t.mms_ao + t.goose_di + t.goose_do + t.goose_ai + t.goose_ao) * q;
                }
            });
            return total;
        }
        
        function updateGenSummary() {
            let html = '';
            projectData.substations.forEach(sub => {
                const signals = sub.feeders.reduce((s, f) => s + (parseInt(f.signals) || 0), 0);
                html += '<div class="summary-item"><label>' + sub.name + ':</label><span>' + sub.feeders.length + ' feeders | ' + signals + ' signals</span></div>';
            });
            document.getElementById('genSummary').innerHTML = html;
        }
        
        function generateExcel() {
            if (!ioListUploaded) {
                alert('âŒ Upload Customer IO List first!');
                return;
            }
            if (projectData.substations.length === 0) {
                alert('âŒ No substations added!');
                return;
            }
            document.getElementById('genStatus').innerHTML = '<div class="loading">â³ Generating...</div>';
            setTimeout(() => {
                try {
                    const wb = XLSX.utils.book_new();
                    createTypicalsSheet(wb);
                    projectData.substations.forEach(sub => createSubSheet(wb, sub));
                    createSummarySheet(wb);
                    const fileName = 'IO_List_' + (projectData.projectName || 'Project').replace(/\s+/g, '_') + '_' + projectData.revision + '.xlsx';
                    XLSX.writeFile(wb, fileName);
                    document.getElementById('genStatus').innerHTML = '<div class="alert alert-success">âœ… Generated: ' + fileName + '</div>';
                } catch (err) {
                    document.getElementById('genStatus').innerHTML = '<div class="alert alert-danger">âŒ Error: ' + err.message + '</div>';
                }
            }, 500);
        }
        
        function createTypicalsSheet(wb) {
            const data = [['TYPICALS - FROM CUSTOMER IO LIST'], [], ['Equipment Type', 'Signals', 'MMS (DI/DO/AI/AO)', 'GOOSE (DI/DO/AI/AO)', 'IEDs']];
            for (const [k, v] of Object.entries(projectData.typicals)) {
                data.push([v.description, v.signal_count, v.mms_di + '/' + v.mms_do + '/' + v.mms_ai + '/' + v.mms_ao, v.goose_di + '/' + v.goose_do + '/' + v.goose_ai + '/' + v.goose_ao, v.ied_count]);
            }
            const ws = XLSX.utils.aoa_to_sheet(data);
            ws['!cols'] = [{wch: 50}, {wch: 10}, {wch: 20}, {wch: 20}, {wch: 8}];
            XLSX.utils.book_append_sheet(wb, ws, 'TYPICALS');
        }
        
        function createSubSheet(wb, sub) {
            const data = [
                ['SUBSTATION ' + sub.name + ' - I/O SUMMARY'],
                [],
                ['Project:', projectData.projectName],
                ['Revision:', projectData.revision],
                ['Date:', new Date().toISOString().split('T')[0]],
                [],
                ['Voltage', 'Feeder ID', 'Name', 'Equipment Type', 'QTY', 'Signals', 'I/O']
            ];
            let total = {signals: 0, io: 0};
            sub.feeders.forEach(f => {
                const t = projectData.typicals[f.equipmentType];
                const io = t ? (t.mms_di + t.mms_ai + t.goose_di) * parseInt(f.qty || 1) : 0;
                total.signals += parseInt(f.signals) || 0;
                total.io += io;
                data.push([f.voltage, f.feederId, f.feederName, t?.description || '', f.qty, f.signals, io]);
            });
            data.push([]);
            data.push(['TOTAL', '', '', '', '', total.signals, total.io]);
            const ws = XLSX.utils.aoa_to_sheet(data);
            ws['!cols'] = [{wch: 10}, {wch: 12}, {wch: 40}, {wch: 45}, {wch: 6}, {wch: 10}, {wch: 10}];
            XLSX.utils.book_append_sheet(wb, ws, sub.name);
        }
        
        function createSummarySheet(wb) {
            const data = [
                ['PROJECT SUMMARY - ALL SUBSTATIONS'],
                [],
                ['Project:', projectData.projectName],
                ['Revision:', projectData.revision],
                ['Customer IO List:', projectData.ioList?.fileName || 'N/A'],
                [],
                ['Substation', 'Feeders', 'Signals', 'I/O Points']
            ];
            let grand = {feeders: 0, signals: 0, io: 0};
            projectData.substations.forEach(sub => {
                const feeders = sub.feeders.length;
                const signals = sub.feeders.reduce((s, f) => s + (parseInt(f.signals) || 0), 0);
                const io = calculateIO(sub);
                grand.feeders += feeders;
                grand.signals += signals;
                grand.io += io;
                data.push([sub.name, feeders, signals, io]);
            });
            data.push([]);
            data.push(['GRAND TOTAL', grand.feeders, grand.signals, grand.io]);
            const ws = XLSX.utils.aoa_to_sheet(data);
            ws['!cols'] = [{wch: 20}, {wch: 12}, {wch: 12}, {wch: 12}];
            XLSX.utils.book_append_sheet(wb, ws, 'SUMMARY');
        }
        
        function saveProject() {
            localStorage.setItem('abbProject', JSON.stringify(projectData));
        }
        
        function loadProject() {
            const saved = localStorage.getItem('abbProject');
            if (saved) {
                projectData = JSON.parse(saved);
                document.getElementById('projectName').value = projectData.projectName || '';
                document.getElementById('revision').value = projectData.revision || 'R0';
                document.getElementById('description').value = projectData.description || '';
                if (projectData.ioList) {
                    ioListUploaded = true;
                    proceedToFeeders();
                }
                updateSubstationDropdown();
            }
        }
        
        window.onload = loadProject;
    </script>
</body>
</html>
