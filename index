<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ABB IO List Generator v4.1 - Fixed PDF Support</title>
    
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script>
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
            console.log('PDF.js loaded');
        }
    </script>
    
    <style>
        :root { --abb-red: #FF000F; --abb-gray: #E8E8E8; --abb-light-gray: #F0F0F0; --abb-dark: #333333; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #f5f5f5 0%, #e0e0e0 100%); padding: 20px; }
        .container { max-width: 1600px; margin: 0 auto; background: white; border-radius: 10px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: var(--abb-red); color: white; padding: 30px; text-align: center; }
        .header h1 { font-size: 32px; margin-bottom: 10px; }
        .header p { font-size: 14px; opacity: 0.9; }
        .tabs { display: flex; background: var(--abb-gray); border-bottom: 3px solid var(--abb-red); overflow-x: auto; }
        .tab { flex: 1; min-width: 140px; padding: 15px 10px; text-align: center; cursor: pointer; background: var(--abb-gray); border: none; font-size: 12px; font-weight: 600; transition: all 0.3s; }
        .tab:hover { background: var(--abb-light-gray); }
        .tab.active { background: white; color: var(--abb-red); }
        .tab.disabled { opacity: 0.5; cursor: not-allowed; pointer-events: none; }
        .tab-content { display: none; padding: 30px; max-height: 70vh; overflow-y: auto; }
        .tab-content.active { display: block; }
        .btn { padding: 12px 30px; border: none; border-radius: 5px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s; margin-right: 10px; margin-bottom: 10px; }
        .btn-primary { background: var(--abb-red); color: white; }
        .btn-primary:hover { background: #cc000c; transform: translateY(-2px); }
        .btn-secondary { background: var(--abb-gray); color: var(--abb-dark); }
        .btn-success { background: #28a745; color: white; font-size: 18px; padding: 20px 50px; }
        .upload-box { border: 3px dashed var(--abb-gray); border-radius: 10px; padding: 40px; text-align: center; background: var(--abb-light-gray); cursor: pointer; margin-bottom: 20px; }
        .upload-box:hover { border-color: var(--abb-red); background: white; }
        .upload-box.uploaded { border-color: #28a745; background: #d4edda; }
        .upload-icon { font-size: 64px; margin-bottom: 20px; }
        .file-input { display: none; }
        .alert { padding: 15px; border-radius: 5px; margin-bottom: 20px; }
        .alert-info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .alert-danger { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 12px; }
        table th, table td { padding: 8px; text-align: left; border: 1px solid var(--abb-gray); }
        table th { background: var(--abb-red); color: white; font-weight: 600; position: sticky; top: 0; }
        table tr:nth-child(even) { background: var(--abb-light-gray); }
        table tr:hover { background: #fff3f3; }
        .summary-box { background: var(--abb-light-gray); padding: 20px; border-radius: 5px; margin-top: 20px; border-left: 5px solid var(--abb-red); }
        .summary-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #ddd; }
        .summary-item label { font-weight: 600; }
        .summary-item span { color: var(--abb-red); font-weight: 700; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; border: 2px solid var(--abb-gray); border-radius: 5px; font-size: 14px; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }
        .delete-btn { background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 3px; cursor: pointer; font-size: 11px; }
        .loading { text-align: center; padding: 40px; font-size: 18px; color: var(--abb-red); }
        .option-card { border: 2px solid var(--abb-gray); border-radius: 10px; padding: 20px; background: white; transition: all 0.3s; }
        .option-card:hover { border-color: var(--abb-red); box-shadow: 0 5px 15px rgba(255,0,15,0.2); }
        .option-card h3 { color: var(--abb-red); margin-bottom: 10px; }
        .badge { display: inline-block; padding: 5px 10px; border-radius: 5px; font-size: 11px; font-weight: 600; margin: 5px; }
        .badge-new { background: #28a745; color: white; }
        .badge-fast { background: #17a2b8; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚ö° ABB IO List Generator</h1>
            <p>v4.1 - PDF Support | SLD Parser | Complete Solution</p>
        </div>
        <div class="tabs">
            <button class="tab active" onclick="showTab(event, 'uploadIOList')">üì§ IO List</button>
            <button class="tab disabled" id="tabImportFeeders" onclick="showTab(event, 'importFeeders')">üì• Import Feeders</button>
            <button class="tab disabled" id="tabProject" onclick="showTab(event, 'project')">üìã Project</button>
            <button class="tab disabled" id="tabManual" onclick="showTab(event, 'manual')">‚úèÔ∏è Manual</button>
            <button class="tab disabled" id="tabReview" onclick="showTab(event, 'review')">üîç Review</button>
            <button class="tab disabled" id="tabSummary" onclick="showTab(event, 'summary')">üè≠ Summary</button>
            <button class="tab disabled" id="tabGenerate" onclick="showTab(event, 'generate')">‚öôÔ∏è Generate</button>
        </div>
        
        <div id="uploadIOList" class="tab-content active">
            <h2>Step 1: Upload Customer IO List</h2>
            <div class="alert alert-info">
                <strong>üìÑ Supported:</strong> Excel (.xlsx, .xls) or PDF (.pdf)
            </div>
            <div class="upload-box" id="ioListBox" onclick="document.getElementById('ioListFile').click()">
                <div class="upload-icon">üìÅ</div>
                <h3>Click to Upload Customer IO List</h3>
                <p style="margin-top: 10px; color: #666;">Excel or PDF format</p>
                <input type="file" id="ioListFile" class="file-input" accept=".xlsx,.xls,.xlsm,.pdf" onchange="handleIOListUpload(event)">
            </div>
            <div id="ioListStatus"></div>
            <div id="ioListInfo" style="display:none;">
                <div class="summary-box">
                    <h3>‚úÖ Uploaded Successfully</h3>
                    <div class="summary-item"><label>File:</label><span id="ioFileName"></span></div>
                    <div class="summary-item"><label>Format:</label><span id="ioFileFormat"></span></div>
                    <div class="summary-item"><label>Equipment Types:</label><span id="ioEquipCount"></span></div>
                </div>
                <button class="btn btn-success" onclick="proceedToFeeders()">‚û°Ô∏è Proceed to Import Feeders</button>
            </div>
        </div>
        
        <div id="importFeeders" class="tab-content">
            <h2>Step 2: Import Feeders</h2>
            <div class="alert alert-info">
                <strong>Choose how to add feeders:</strong> Upload feeders list, extract from SLD, or enter manually
            </div>
            <div class="grid-3">
                <div class="option-card">
                    <h3>Option A: Feeders List</h3>
                    <span class="badge badge-fast">FASTEST</span>
                    <p style="margin: 10px 0; color: #666;">Upload Excel/CSV with feeders</p>
                    <div class="upload-box" onclick="document.getElementById('feedersListFile').click()" style="padding: 20px; margin-top: 15px;">
                        <div style="font-size: 32px;">üìä</div>
                        <p style="font-size: 12px; margin-top: 5px;">Upload Feeders List</p>
                        <input type="file" id="feedersListFile" class="file-input" accept=".xlsx,.xls,.csv" onchange="handleFeedersListUpload(event)">
                    </div>
                </div>
                <div class="option-card">
                    <h3>Option B: SLD Parser</h3>
                    <span class="badge badge-new">NEW!</span>
                    <p style="margin: 10px 0; color: #666;">Extract from SLD (PDF)</p>
                    <div class="upload-box" onclick="document.getElementById('sldFile').click()" style="padding: 20px; margin-top: 15px;">
                        <div style="font-size: 32px;">üìÑ</div>
                        <p style="font-size: 12px; margin-top: 5px;">Upload SLD (PDF)</p>
                        <input type="file" id="sldFile" class="file-input" accept=".pdf" onchange="handleSLDUpload(event)">
                    </div>
                </div>
                <div class="option-card">
                    <h3>Option C: Manual Entry</h3>
                    <p style="margin: 10px 0; color: #666;">Add feeders manually</p>
                    <button class="btn btn-secondary" onclick="skipToManual()" style="margin-top: 15px; width: 100%;">‚úèÔ∏è Manual Entry</button>
                </div>
            </div>
            <div id="feedersStatus" style="margin-top: 20px;"></div>
        </div>
        
        <div id="project" class="tab-content">
            <h2>Project Information</h2>
            <div class="grid-2">
                <div class="form-group"><label>Project Name</label><input type="text" id="projectName"></div>
                <div class="form-group"><label>Revision</label><input type="text" id="revision" value="R0"></div>
            </div>
            <button class="btn btn-primary" onclick="saveProject()">üíæ Save</button>
        </div>
        
        <div id="manual" class="tab-content">
            <h2>Manual Feeder Entry</h2>
            <div class="form-group">
                <label>Substation</label>
                <select id="currentSub" onchange="loadFeeders()"><option value="">-- Select --</option></select>
                <button class="btn btn-primary" onclick="createSubstation()">‚ûï New Substation</button>
            </div>
            <div id="manualEntry" style="display:none;">
                <button class="btn btn-primary" onclick="addFeeder()">‚ûï Add Feeder</button>
                <table><thead><tr><th>Voltage</th><th>ID</th><th>Name</th><th>Equipment</th><th>QTY</th><th>Signals</th><th>Action</th></tr></thead>
                <tbody id="feedersBody"></tbody></table>
            </div>
        </div>
        
        <div id="review" class="tab-content"><h2>Review Feeders</h2><div id="reviewContent"></div></div>
        <div id="summary" class="tab-content"><h2>Summary</h2><div id="summaryContent"></div></div>
        
        <div id="generate" class="tab-content">
            <h2>Generate Excel</h2>
            <div class="summary-box" id="genSummary"></div>
            <div style="text-align: center; margin-top: 30px;">
                <button class="btn btn-success" onclick="generateExcel()">‚öôÔ∏è GENERATE EXCEL</button>
            </div>
            <div id="genStatus"></div>
        </div>
    </div>
    
    <script>
        let projectData = { ioList: null, typicals: {}, projectName: "", revision: "R0", substations: [] };
        let ioListUploaded = false;
        
        window.addEventListener('load', function() {
            if (typeof pdfjsLib === 'undefined') {
                console.error('PDF.js failed to load');
            }
        });
        
        function showTab(e, name) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(name).classList.add('active');
            if(e) e.target.classList.add('active');
            if (name === 'review') updateReview();
            if (name === 'summary') updateSummary();
            if (name === 'generate') updateGenSummary();
        }
        
        async function handleIOListUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            const ext = file.name.split('.').pop().toLowerCase();
            document.getElementById('ioListStatus').innerHTML = '<div class="loading">‚è≥ Processing...</div>';
            
            if (ext === 'pdf') {
                if (typeof pdfjsLib === 'undefined') {
                    document.getElementById('ioListStatus').innerHTML = '<div class="alert alert-danger">‚ùå PDF support not available. Please use Excel format.</div>';
                    return;
                }
                await parsePDFIOList(file);
            } else {
                parseExcelIOList(file);
            }
        }
        
        async function parsePDFIOList(file) {
            try {
                const arrayBuffer = await file.arrayBuffer();
                const loadingTask = pdfjsLib.getDocument({data: arrayBuffer});
                const pdf = await loadingTask.promise;
                let allText = '';
                
                for (let i = 1; i <= pdf.numPages; i++) {
                    document.getElementById('ioListStatus').innerHTML = '<div class="loading">‚è≥ Reading page ' + i + ' of ' + pdf.numPages + '...</div>';
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(' ');
                    allText += pageText + '\n';
                }
                
                const typicals = extractTypicalsFromText(allText);
                if (Object.keys(typicals).length === 0) {
                    typicals['Generic Equipment'] = { description: 'Generic Equipment', signal_count: 30, mms_di: 15, mms_do: 5, mms_ai: 5, mms_ao: 2, goose_di: 3, goose_do: 0, goose_ai: 0, goose_ao: 0, ied_count: 1, modbus_count: 0 };
                }
                
                projectData.typicals = typicals;
                projectData.ioList = { fileName: file.name, format: 'PDF', date: new Date().toISOString().split('T')[0] };
                ioListUploaded = true;
                showIOListSuccess();
            } catch (err) {
                document.getElementById('ioListStatus').innerHTML = '<div class="alert alert-danger">‚ùå Error: ' + err.message + '</div>';
            }
        }
        
        function extractTypicalsFromText(text) {
            const typicals = {};
            const lines = text.split('\n');
            
            for (let line of lines) {
                line = line.trim();
                if (line.length < 20) continue;
                
                const hasVoltage = /\d+\.?\d*\s*kV/i.test(line);
                const hasKeyword = /(switchgear|transformer|motor|feeder|incomer|outgoing|breaker)/i.test(line);
                
                if (hasVoltage || hasKeyword) {
                    const numbers = line.match(/\b\d+\b/g);
                    if (numbers && numbers.length >= 3) {
                        const firstNum = numbers[0];
                        const idx = line.indexOf(firstNum);
                        let eqName = line.substring(0, idx).trim();
                        
                        if (eqName.length >= 15 && !typicals[eqName]) {
                            typicals[eqName] = {
                                description: eqName,
                                signal_count: parseInt(numbers[0]) || 20,
                                mms_di: parseInt(numbers[1]) || 10,
                                mms_do: parseInt(numbers[2]) || 5,
                                mms_ai: parseInt(numbers[3]) || 3,
                                mms_ao: parseInt(numbers[4]) || 2,
                                goose_di: parseInt(numbers[5]) || 5,
                                goose_do: 0, goose_ai: 0, goose_ao: 0,
                                ied_count: 1, modbus_count: 0
                            };
                        }
                    }
                }
            }
            
            return typicals;
        }
        
        function parseExcelIOList(file) {
            const reader = new FileReader();
            reader.onload = function(ev) {
                try {
                    const data = new Uint8Array(ev.target.result);
                    const wb = XLSX.read(data, {type: 'array'});
                    let sheet = wb.SheetNames.includes('TYPICALS') ? wb.Sheets['TYPICALS'] : wb.Sheets[wb.SheetNames[0]];
                    const rows = XLSX.utils.sheet_to_json(sheet, {header: 1});
                    projectData.typicals = parseTypicalsFromRows(rows);
                    projectData.ioList = { fileName: file.name, format: 'Excel', date: new Date().toISOString().split('T')[0] };
                    ioListUploaded = true;
                    showIOListSuccess();
                } catch (err) {
                    document.getElementById('ioListStatus').innerHTML = '<div class="alert alert-danger">‚ùå Error: ' + err.message + '</div>';
                }
            };
            reader.readAsArrayBuffer(file);
        }
        
        function parseTypicalsFromRows(rows) {
            const typicals = {};
            let headerRow = -1;
            
            for (let i = 0; i < rows.length; i++) {
                if (rows[i][0] && (rows[i][0].toString().includes('Types of Typicals') || rows[i][0].toString().includes('Equipment'))) {
                    headerRow = i;
                    break;
                }
            }
            
            const startRow = headerRow === -1 ? 0 : headerRow + 2;
            
            for (let i = startRow; i < rows.length; i++) {
                const row = rows[i];
                if (!row || !row[0]) continue;
                const eqType = row[0].toString().trim();
                if (eqType.length < 10) continue;
                
                if (!typicals[eqType]) {
                    typicals[eqType] = {
                        description: eqType,
                        signal_count: 0,
                        mms_di: 0, mms_do: 0, mms_ai: 0, mms_ao: 0,
                        goose_di: 0, goose_do: 0, goose_ai: 0, goose_ao: 0,
                        ied_count: 0, modbus_count: 0
                    };
                }
                typicals[eqType].signal_count++;
                if (row[12]) typicals[eqType].mms_di += parseInt(row[12]) || 0;
                if (row[13]) typicals[eqType].mms_do += parseInt(row[13]) || 0;
                if (row[14]) typicals[eqType].mms_ai += parseInt(row[14]) || 0;
                if (row[15]) typicals[eqType].mms_ao += parseInt(row[15]) || 0;
                if (row[16]) typicals[eqType].goose_di += parseInt(row[16]) || 0;
                if (row[20]) typicals[eqType].ied_count = Math.max(typicals[eqType].ied_count, parseInt(row[20]) || 0);
            }
            
            return typicals;
        }
        
        function showIOListSuccess() {
            document.getElementById('ioListBox').classList.add('uploaded');
            document.getElementById('ioListBox').innerHTML = '<div class="upload-icon">‚úÖ</div><h3>Success!</h3>';
            document.getElementById('ioFileName').textContent = projectData.ioList.fileName;
            document.getElementById('ioFileFormat').textContent = projectData.ioList.format;
            document.getElementById('ioEquipCount').textContent = Object.keys(projectData.typicals).length;
            document.getElementById('ioListInfo').style.display = 'block';
            document.getElementById('ioListStatus').innerHTML = '';
            saveProject();
        }
        
        function proceedToFeeders() {
            ['tabImportFeeders', 'tabProject', 'tabManual', 'tabReview', 'tabSummary', 'tabGenerate'].forEach(id => 
                document.getElementById(id).classList.remove('disabled')
            );
            showTab(null, 'importFeeders');
        }
        
        async function handleSLDUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            if (typeof pdfjsLib === 'undefined') {
                document.getElementById('feedersStatus').innerHTML = '<div class="alert alert-danger">‚ùå PDF support not available.</div>';
                return;
            }
            
            document.getElementById('feedersStatus').innerHTML = '<div class="loading">‚è≥ Parsing SLD...</div>';
            
            try {
                const arrayBuffer = await file.arrayBuffer();
                const loadingTask = pdfjsLib.getDocument({data: arrayBuffer});
                const pdf = await loadingTask.promise;
                let allText = '';
                
                for (let i = 1; i <= pdf.numPages; i++) {
                    document.getElementById('feedersStatus').innerHTML = '<div class="loading">‚è≥ Reading page ' + i + ' of ' + pdf.numPages + '...</div>';
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(' ');
                    allText += pageText + '\n';
                }
                
                const feeders = extractFeedersFromSLD(allText);
                
                if (feeders.length === 0) {
                    throw new Error('No feeders found in SLD.');
                }
                
                importFeedersFromSLD(feeders);
                document.getElementById('feedersStatus').innerHTML = '<div class="alert alert-success">‚úÖ Extracted ' + feeders.length + ' feeders!</div>';
                updateSubstationDropdown();
                saveProject();
                
            } catch (err) {
                document.getElementById('feedersStatus').innerHTML = '<div class="alert alert-danger">‚ùå Error: ' + err.message + '</div>';
            }
        }
        
        function extractFeedersFromSLD(text) {
            const feeders = [];
            const lines = text.split('\n');
            let currentSubstation = 'SS-001';
            let currentVoltage = '6.3kV';
            
            for (let line of lines) {
                line = line.trim();
                if (!line) continue;
                
                const subMatch = line.match(/(SS|SUB|SUBSTATION)[\s-]*(\d+)/i);
                if (subMatch) {
                    currentSubstation = 'SS-' + subMatch[2].padStart(3, '0');
                    continue;
                }
                
                const voltMatch = line.match(/(\d+\.?\d*)\s*kV/i);
                if (voltMatch) {
                    currentVoltage = voltMatch[1] + 'kV';
                }
                
                const feederPatterns = [
                    /\b(OUT|INC|MTR|TRF|BUS|FDR|CB)[\s-]*(\d+)[:\s-]*([^\n]{5,50})/i,
                    /\b(\d{3,4})[:\s-]*([^\n]{10,50})/
                ];
                
                for (let pattern of feederPatterns) {
                    const match = line.match(pattern);
                    if (match) {
                        const feederId = match[1] + '-' + (match[2] || '01');
                        const feederName = (match[3] || match[2] || '').trim();
                        
                        if (feederName.length >= 5) {
                            let equipmentType = '';
                            for (const [key, val] of Object.entries(projectData.typicals)) {
                                if (feederName.toLowerCase().includes('incomer') || feederId.includes('INC')) {
                                    if (key.toLowerCase().includes('incomer')) { equipmentType = key; break; }
                                } else if (feederName.toLowerCase().includes('motor') || feederId.includes('MTR')) {
                                    if (key.toLowerCase().includes('motor')) { equipmentType = key; break; }
                                } else if (feederName.toLowerCase().includes('transformer') || feederId.includes('TRF')) {
                                    if (key.toLowerCase().includes('transformer')) { equipmentType = key; break; }
                                } else if (feederName.toLowerCase().includes('outgoing') || feederId.includes('OUT')) {
                                    if (key.toLowerCase().includes('outgoing')) { equipmentType = key; break; }
                                }
                            }
                            
                            if (!equipmentType && Object.keys(projectData.typicals).length > 0) {
                                equipmentType = Object.keys(projectData.typicals)[0];
                            }
                            
                            feeders.push({
                                Substation: currentSubstation,
                                Voltage: currentVoltage,
                                'Feeder ID': feederId,
                                'Feeder Name': feederName,
                                'Equipment Type': equipmentType,
                                QTY: 1
                            });
                            break;
                        }
                    }
                }
            }
            
            return feeders;
        }
        
        function importFeedersFromSLD(feeders) {
            feeders.forEach(row => {
                const subName = row.Substation;
                let sub = projectData.substations.find(s => s.name === subName);
                if (!sub) {
                    sub = {name: subName, feeders: []};
                    projectData.substations.push(sub);
                }
                const eqType = row['Equipment Type'];
                const typ = projectData.typicals[eqType];
                sub.feeders.push({
                    voltage: row.Voltage,
                    feederId: row['Feeder ID'],
                    feederName: row['Feeder Name'],
                    equipmentType: eqType,
                    qty: parseInt(row.QTY || 1),
                    signals: typ ? typ.signal_count * parseInt(row.QTY || 1) : 0
                });
            });
        }
        
        function handleFeedersListUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            document.getElementById('feedersStatus').innerHTML = '<div class="loading">‚è≥ Importing...</div>';
            
            const reader = new FileReader();
            reader.onload = function(ev) {
                try {
                    const data = new Uint8Array(ev.target.result);
                    const wb = XLSX.read(data, {type: 'array'});
                    const sheet = wb.Sheets[wb.SheetNames[0]];
                    const rows = XLSX.utils.sheet_to_json(sheet);
                    importFeedersFromList(rows);
                    document.getElementById('feedersStatus').innerHTML = '<div class="alert alert-success">‚úÖ Imported ' + rows.length + ' feeders!</div>';
                    updateSubstationDropdown();
                    saveProject();
                } catch (err) {
                    document.getElementById('feedersStatus').innerHTML = '<div class="alert alert-danger">‚ùå Error: ' + err.message + '</div>';
                }
            };
            reader.readAsArrayBuffer(file);
        }
        
        function importFeedersFromList(rows) {
            rows.forEach(row => {
                const subName = row.Substation || row.substation || '';
                if (!subName) return;
                let sub = projectData.substations.find(s => s.name === subName);
                if (!sub) {
                    sub = {name: subName, feeders: []};
                    projectData.substations.push(sub);
                }
                const eqType = row['Equipment Type'] || row.equipment_type || '';
                const typ = projectData.typicals[eqType];
                sub.feeders.push({
                    voltage: row.Voltage || '6.3kV',
                    feederId: row['Feeder ID'] || '',
                    feederName: row['Feeder Name'] || row.Name || '',
                    equipmentType: eqType,
                    qty: parseInt(row.QTY || 1),
                    signals: typ ? typ.signal_count * parseInt(row.QTY || 1) : 0
                });
            });
        }
        
        function skipToManual() { showTab(null, 'project'); }
        function createSubstation() {
            const name = prompt('Enter substation name:');
            if (name && name.trim()) {
                projectData.substations.push({name: name.trim(), feeders: []});
                updateSubstationDropdown();
                document.getElementById('currentSub').value = name.trim();
                loadFeeders();
                saveProject();
            }
        }
        function updateSubstationDropdown() {
            const sel = document.getElementById('currentSub');
            sel.innerHTML = '<option value="">-- Select --</option>';
            projectData.substations.forEach(s => sel.innerHTML += '<option value="' + s.name + '">' + s.name + '</option>');
        }
        function loadFeeders() {
            const subName = document.getElementById('currentSub').value;
            document.getElementById('manualEntry').style.display = subName ? 'block' : 'none';
            if (subName) renderFeeders();
        }
        function addFeeder() {
            const subName = document.getElementById('currentSub').value;
            const sub = projectData.substations.find(s => s.name === subName);
            if (sub) {
                sub.feeders.push({voltage: '6.3kV', feederId: '', feederName: '', equipmentType: '', qty: 1, signals: 0});
                renderFeeders();
                saveProject();
            }
        }
        function renderFeeders() {
            const subName = document.getElementById('currentSub').value;
            const sub = projectData.substations.find(s => s.name === subName);
            if (!sub) return;
            let html = '';
            sub.feeders.forEach((f, i) => {
                html += '<tr><td><select onchange="updateFeeder(' + i + ', \'voltage\', this.value)">';
                ['36kV', '6.3kV', '400V'].forEach(v => html += '<option value="' + v + '"' + (f.voltage === v ? ' selected' : '') + '>' + v + '</option>');
                html += '</select></td>';
                html += '<td><input type="text" value="' + f.feederId + '" onchange="updateFeeder(' + i + ', \'feederId\', this.value)"></td>';
                html += '<td><input type="text" value="' + f.feederName + '" onchange="updateFeeder(' + i + ', \'feederName\', this.value)"></td>';
                html += '<td><select onchange="updateFeeder(' + i + ', \'equipmentType\', this.value)"><option value="">-- Select --</option>';
                for (const [key, val] of Object.entries(projectData.typicals)) {
                    html += '<option value="' + key + '"' + (f.equipmentType === key ? ' selected' : '') + '>' + val.description.substring(0, 40) + '</option>';
                }
                html += '</select></td>';
                html += '<td><input type="number" value="' + f.qty + '" min="1" onchange="updateFeeder(' + i + ', \'qty\', this.value)"></td>';
                html += '<td><input type="number" value="' + f.signals + '" readonly style="background:#f0f0f0;"></td>';
                html += '<td><button class="delete-btn" onclick="deleteFeeder(' + i + ')">Delete</button></td></tr>';
            });
            document.getElementById('feedersBody').innerHTML = html;
        }
        function updateFeeder(idx, field, val) {
            const sub = projectData.substations.find(s => s.name === document.getElementById('currentSub').value);
            if (sub && sub.feeders[idx]) {
                sub.feeders[idx][field] = val;
                if (field === 'equipmentType' || field === 'qty') {
                    const f = sub.feeders[idx];
                    if (f.equipmentType && projectData.typicals[f.equipmentType]) {
                        f.signals = projectData.typicals[f.equipmentType].signal_count * parseInt(f.qty || 1);
                    }
                }
                renderFeeders();
                saveProject();
            }
        }
        function deleteFeeder(idx) {
            if (confirm('Delete?')) {
                const sub = projectData.substations.find(s => s.name === document.getElementById('currentSub').value);
                if (sub) {
                    sub.feeders.splice(idx, 1);
                    renderFeeders();
                    saveProject();
                }
            }
        }
        function updateReview() {
            let html = '';
            projectData.substations.forEach(sub => {
                html += '<h3>' + sub.name + ' (' + sub.feeders.length + ' feeders)</h3><table><thead><tr><th>Voltage</th><th>ID</th><th>Name</th><th>Equipment</th><th>QTY</th><th>Signals</th></tr></thead><tbody>';
                sub.feeders.forEach(f => {
                    html += '<tr><td>' + f.voltage + '</td><td>' + f.feederId + '</td><td>' + f.feederName + '</td><td>' + (projectData.typicals[f.equipmentType]?.description || '').substring(0, 40) + '</td><td>' + f.qty + '</td><td>' + f.signals + '</td></tr>';
                });
                html += '</tbody></table>';
            });
            document.getElementById('reviewContent').innerHTML = html || '<p>No feeders</p>';
        }
        function updateSummary() {
            let html = '';
            projectData.substations.forEach(sub => {
                const signals = sub.feeders.reduce((s, f) => s + (parseInt(f.signals) || 0), 0);
                html += '<div style="background:#f0f0f0;padding:20px;margin:10px 0;border-left:5px solid #FF000F;"><h4>' + sub.name + '</h4><p>Feeders: ' + sub.feeders.length + ' | Signals: ' + signals + '</p></div>';
            });
            document.getElementById('summaryContent').innerHTML = html;
        }
        function updateGenSummary() {
            let html = '';
            projectData.substations.forEach(sub => {
                const signals = sub.feeders.reduce((s, f) => s + (parseInt(f.signals) || 0), 0);
                html += '<div class="summary-item"><label>' + sub.name + ':</label><span>' + sub.feeders.length + ' feeders | ' + signals + ' signals</span></div>';
            });
            document.getElementById('genSummary').innerHTML = html;
        }
        function generateExcel() {
            if (!ioListUploaded) { alert('Upload IO List first!'); return; }
            if (projectData.substations.length === 0) { alert('No substations!'); return; }
            document.getElementById('genStatus').innerHTML = '<div class="loading">‚è≥ Generating...</div>';
            setTimeout(() => {
                try {
                    const wb = XLSX.utils.book_new();
                    const typData = [['TYPICALS'], [], ['Equipment Type', 'Signals']];
                    for (const [k, v] of Object.entries(projectData.typicals)) {
                        typData.push([v.description, v.signal_count]);
                    }
                    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(typData), 'TYPICALS');
                    
                    projectData.substations.forEach(sub => {
                        const data = [['SUBSTATION ' + sub.name], [], ['Voltage', 'ID', 'Name', 'Equipment', 'QTY', 'Signals']];
                        sub.feeders.forEach(f => {
                            data.push([f.voltage, f.feederId, f.feederName, projectData.typicals[f.equipmentType]?.description || '', f.qty, f.signals]);
                        });
                        XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(data), sub.name);
                    });
                    
                    const sumData = [['SUMMARY'], [], ['Substation', 'Feeders', 'Signals']];
                    projectData.substations.forEach(sub => {
                        sumData.push([sub.name, sub.feeders.length, sub.feeders.reduce((s, f) => s + (parseInt(f.signals) || 0), 0)]);
                    });
                    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(sumData), 'SUMMARY');
                    
                    XLSX.writeFile(wb, 'IO_List_' + (projectData.projectName || 'Project') + '_' + projectData.revision + '.xlsx');
                    document.getElementById('genStatus').innerHTML = '<div class="alert alert-success">‚úÖ Generated!</div>';
                } catch (err) {
                    document.getElementById('genStatus').innerHTML = '<div class="alert alert-danger">‚ùå Error: ' + err.message + '</div>';
                }
            }, 500);
        }
        function saveProject() {
            projectData.projectName = document.getElementById('projectName').value;
            projectData.revision = document.getElementById('revision').value;
            localStorage.setItem('abbProject', JSON.stringify(projectData));
        }
        function loadProject() {
            const saved = localStorage.getItem('abbProject');
            if (saved) {
                projectData = JSON.parse(saved);
                document.getElementById('projectName').value = projectData.projectName || '';
                document.getElementById('revision').value = projectData.revision || 'R0';
                if (projectData.ioList) {
                    ioListUploaded = true;
                    proceedToFeeders();
                }
                updateSubstationDropdown();
            }
        }
        window.onload = loadProject;
    </script>
</body>
</html>
